import{n as e}from"./index-BXaSDRPy.js";import{_ as t,h as i}from"./index-C3Re8InM.js";import{o as s,c as a,S as r,K as l,L as o,J as n,O as d,a as p,P as u,Q as c,R as m,aj as h,at as y}from"./@vue-_BCsYqm-.js";import"./element-plus-CoQd9HEf.js";import"./lodash-es-DCh--ulG.js";import"./@vueuse-DKZ1O7gq.js";import"./@element-plus-DpD46RjY.js";import"./@sxzz-CpAfbxx4.js";import"./@ctrl-D2oWfImC.js";import"./dayjs-Cud5yAXI.js";import"./async-validator-BTKOuuO-.js";import"./memoize-one-Ds0C_khL.js";import"./normalize-wheel-es-Vn5vHDCm.js";import"./@floating-ui-DT7V1Oc1.js";import"./crypto-js-BfYQ37JU.js";import"./axios-DMXdiZgf.js";import"./vue-router-CJBOlWwF.js";import"./nprogress-BX4rmQ7W.js";import"./vuex-CNGLPxA3.js";import"./json-bigint-D0bu8vFr.js";import"./bignumber.js-iDjSUVmj.js";import"./vue-i18n-DbMEmpqT.js";import"./@intlify-CZIS8eQd.js";import"./vue3-json-viewer-B-aZDOpp.js";import"./ace-builds-D9YH2WY7.js";import"./vue3-ace-editor-ubj-WOyx.js";import"./resize-observer-polyfill-CzGuHLZU.js";import"./sortablejs-BALiOaUQ.js";import"./vkbeautify-DEVEMlla.js";const f={components:{naInfo:e},computed:{},created(){},data(){return{statistics:{total:"..."},dialog:{info:!1},ips:[],loading:!1,query:{dynamicFilter:{filters:[]},filter:{},keywords:this.keywords},selection:[]}},inject:["reload"],methods:{async getStatistics(){var e;this.statistics.total=null==(e=this.$refs.table)?void 0:e.total;const t=await Promise.all([this.$API.sys_loginlog.countBy.post({dynamicFilter:{filters:this.query.dynamicFilter.filters},requiredFields:["ErrorCode"]}),this.$API.sys_loginlog.countBy.post({dynamicFilter:{filters:[...this.query.dynamicFilter.filters,{field:"LoginUserName",operator:"notEqual"}]},requiredFields:["LoginUserName"]}),this.$API.sys_loginlog.countBy.post({dynamicFilter:{filters:[...this.query.dynamicFilter.filters,{field:"CreatedClientIp",operator:"notEqual"}]},requiredFields:["CreatedClientIp"]})]);this.statistics.errorCode=t[0].data,this.statistics.loginUserName=t[1].data,this.statistics.createdClientIp=t[2].data},async dataChange(e){var t;this.apis=[];const s=(null==(t=e.data.rows)?void 0:t.map((e=>e.createdClientIp)))??[],a=await Promise.all([s&&s.length>0?i.get(`https://ip.tools92.top/?ip=${s.join("&ip=")}`):new Promise((e=>e({data:[]})))]);this.ips=a[0],await this.getStatistics()},filterChange(e){Object.entries(e).forEach((([e,t])=>{this.$refs.search.form.dy[e]="true"===t||"false"!==t&&t})),this.$refs.search.search()},onReset(){this.showFilter&&Object.entries(this.$refs.selectFilter.selected).forEach((([e,t])=>this.$refs.selectFilter.selected[e]=[""]))},async onSearch(e){Array.isArray(e.dy.createdTime)&&this.query.dynamicFilter.filters.push({field:"createdTime",operator:"dateRange",value:e.dy.createdTime.map((e=>e.replace(/ 00:00:00$/,"")))}),"boolean"==typeof e.dy.loginResult&&this.query.dynamicFilter.filters.push(e.dy.loginResult?{field:"httpStatusCode",operator:"range",value:"200,299"}:{field:"httpStatusCode",operator:"range",value:"300,999"}),"string"==typeof e.dy.errorCode&&""!==e.dy.errorCode.trim()&&this.query.dynamicFilter.filters.push({field:"errorCode",operator:"eq",value:e.dy.errorCode}),"string"==typeof e.dy.loginUserName&&""!==e.dy.loginUserName.trim()&&this.query.dynamicFilter.filters.push({field:"loginUserName",operator:"eq",value:e.dy.loginUserName}),"string"==typeof e.dy.createdClientIp&&""!==e.dy.createdClientIp.trim()&&this.query.dynamicFilter.filters.push({field:"createdClientIp",operator:"eq",value:e.dy.createdClientIp}),await this.$refs.table.upData()},async rowClick(e){this.dialog.info=!0,await this.$nextTick(),await this.$refs.info.open((()=>this.$t("日志详情：{id}",{id:e.id})),(()=>this.$API.sys_loginlog.get.post({id:e.id})))}},async mounted(){this.keywords&&(this.$refs.search.form.root.keywords=this.keywords,this.$refs.search.keeps.push({field:"keywords",value:this.keywords,type:"root"}))},props:{keywords:{type:String},showFilter:{type:Boolean,default:!0}},watch:{}},g={class:"left-panel"};const v=t(f,[["render",function(e,t,i,f,v,C){const b=h("scStatistic"),w=h("el-card"),j=h("el-col"),$=h("el-row"),k=h("el-header"),I=h("scSelectFilter"),F=h("na-search"),q=h("naColId"),_=h("scStatusIndicator"),S=h("el-table-column"),U=h("naColOperation"),x=h("scTable"),N=h("el-main"),P=h("el-container"),A=h("na-info"),R=y("loading");return s(),a(m,null,[r(P,null,{default:l((()=>[o((s(),n(k,{class:"el-header-statistics"},{default:l((()=>[r($,{gutter:15},{default:l((()=>[r(j,{lg:24},{default:l((()=>[r(w,{shadow:"never"},{default:l((()=>[r(b,{value:v.statistics.total,"group-separator":"",title:"总数"},null,8,["value"])])),_:1})])),_:1})])),_:1})])),_:1})),[[R,"..."===v.statistics.total]]),r(k,{class:"el-header-select-filter"},{default:l((()=>{var t,a,r;return[i.showFilter?(s(),n(I,{key:0,data:[{title:e.$t("登录结果"),key:"loginResult",options:[{label:e.$t("全部"),value:""},{label:e.$t("成功"),value:!0},{label:e.$t("失败"),value:!1}]},{title:e.$t("错误码"),key:"errorCode",options:[{label:e.$t("全部"),value:""},...(null==(t=this.statistics.errorCode)?void 0:t.map((e=>({value:e.key.errorCode,label:e.key.errorCode,badge:e.value}))))??[]]},{title:e.$t("登录用户名"),key:"loginUserName",options:[{label:e.$t("全部"),value:""},...(null==(a=this.statistics.loginUserName)?void 0:a.map((e=>({value:e.key.loginUserName,label:e.key.loginUserName,badge:e.value}))))??[]]},{title:e.$t("客户端IP地址"),key:"createdClientIp",options:[{label:e.$t("全部"),value:""},...(null==(r=this.statistics.createdClientIp)?void 0:r.map((e=>({value:e.key.createdClientIp,label:e.key.createdClientIp,badge:e.value}))))??[]]}],"label-width":10,onOnChange:C.filterChange,ref:"selectFilter"},null,8,["data","onOnChange"])):d("",!0)]})),_:1}),r(k,null,{default:l((()=>[p("div",g,[r(F,{controls:[{type:"input",field:["root","keywords"],placeholder:e.$t("日志编号 / 登录名 / 客户端IP"),style:"width:25rem"}],vue:this,onReset:C.onReset,onSearch:C.onSearch,dateFormat:"YYYY-MM-DD HH:mm:ss",dateType:"datetimerange",dateValueFormat:"YYYY-MM-DD HH:mm:ss",ref:"search"},null,8,["controls","onReset","onSearch"])]),t[0]||(t[0]=p("div",{class:"right-panel"},null,-1))])),_:1}),r(N,{class:"nopadding"},{default:l((()=>[r(x,{"context-menus":["id","httpStatusCode","loginUserName","createdClientIp","createdUserAgent","createdTime"],"context-opers":["view"],"default-sort":{prop:"id",order:"descending"},"export-api":e.$API.sys_loginlog.export,params:v.query,"query-api":e.$API.sys_loginlog.pagedQuery,vue:this,onDataChange:C.dataChange,ref:"table","remote-filter":"","remote-sort":"","row-key":"id",stripe:""},{default:l((()=>[r(q,{label:"日志编号",prop:"id",sortable:"custom",width:"170"}),r(S,{label:e.$t("结果"),align:"center",prop:"httpStatusCode",sortable:"custom",width:"100"},{default:l((({row:e})=>[r(_,{type:200===e.httpStatusCode?"success":"danger"},null,8,["type"]),u(" "+c(200===e.httpStatusCode?"成功":"失败"),1)])),_:1},8,["label"]),r(S,{label:e.$t("登录名"),prop:"loginUserName",sortable:"custom",width:"150"},null,8,["label"]),r(S,{label:e.$t("客户端IP"),prop:"createdClientIp","show-overflow-tooltip":"",sortable:"custom",width:"200"},{default:l((({row:e})=>{var t;return[v.ips&&v.ips.length>0&&e.createdClientIp?(s(),a(m,{key:0},[p("p",null,c(e.createdClientIp),1),p("p",null,c((null==(t=this.ips.filter((t=>t.ip===e.createdClientIp))[0])?void 0:t.region)??"..."),1)],64)):d("",!0)]})),_:1},8,["label"]),r(S,{label:e.$t("操作系统"),align:"center",prop:"os",width:"150"},null,8,["label"]),r(S,{label:e.$t("用户代理"),"min-width":"150",prop:"createdUserAgent","show-overflow-tooltip":"",sortable:"custom"},null,8,["label"]),r(U,{buttons:[{icon:"el-icon-view",title:"查看",click:C.rowClick}],vue:this,width:"70"},null,8,["buttons"])])),_:1},8,["export-api","params","query-api","onDataChange"])])),_:1})])),_:1}),v.dialog.info?(s(),n(A,{key:0,ref:"info"},null,512)):d("",!0)],64)}]]);export{v as default};
