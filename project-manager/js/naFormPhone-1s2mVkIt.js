import{ag as e,b as t,_ as i,k as a,e as l,j as o,aj as r,o as s,c as n,G as c,a as d,L as p,T as h,S as u,K as v,F as g,Q as m,O as y,U as f,i as b,n as S,w as A,P as w,J as x,M as z,R as k}from"./@vue-_BCsYqm-.js";import{_ as B,t as I,b as F}from"./index-C3Re8InM.js";const $={style:{position:"relative"}},T=["src"],W=["textContent"],L=["textContent"],C=["src"];const H=B({props:{captchaType:{type:String},tpl:{type:String},type:{type:String,default:"1"},mode:{type:String,default:"fixed"},vSpace:{type:Number,default:5},explain:{type:String},imgSize:{type:Object,default:()=>({width:"310px",height:"155px"})},blockSize:{type:Object,default:()=>({width:"50px",height:"50px"})},barSize:{type:Object,default:()=>({width:"310px",height:"40px"})}},setup(r,s){const{mode:n,captchaType:c,vSpace:d,imgSize:p,barSize:h,type:u,blockSize:v,explain:g}=e(r),{proxy:m}=b();let y=t(I.crypto.generateDerivedKey(m.tpl)),f=t(""),A=t("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"),w=t("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"),x=t(""),z=t(""),k=t(""),B=t(""),$=t(""),T=t(""),W=t(""),L=i({imgHeight:0,imgWidth:0,barHeight:0,barWidth:0}),C=t(0),H=t(0),O=t(void 0),E=t(void 0),D=t(void 0),_=t("gainsboro"),j=t(void 0),M=t("icon-right"),R=t(!1),V=t(!1),P=t(!0),N=t(""),q=t(""),G=t(0);const X=a((()=>m.$el.querySelector(".verify-bar-area")));function K(){T.value=g.value,J(),S((()=>{let{imgHeight:e,imgWidth:t,barHeight:i,barWidth:a}=function(e){let t,i,a,l;const o=e.$el.parentNode.offsetWidth||window.offsetWidth,r=e.$el.parentNode.offsetHeight||window.offsetHeight;return t=-1!==e.imgSize.width.indexOf("%")?parseInt(e.imgSize.width)/100*o+"px":e.imgSize.width,i=-1!==e.imgSize.height.indexOf("%")?parseInt(e.imgSize.height)/100*r+"px":e.imgSize.height,a=-1!==e.barSize.width.indexOf("%")?parseInt(e.barSize.width)/100*o+"px":e.barSize.width,l=-1!==e.barSize.height.indexOf("%")?parseInt(e.barSize.height)/100*r+"px":e.barSize.height,{imgWidth:t,imgHeight:i,barWidth:a,barHeight:l}}(m);L.imgHeight=e,L.imgWidth=t,L.barHeight=i,L.barWidth=a,m.$parent.$emit("ready",m)})),window.removeEventListener("touchmove",(function(e){U(e)})),window.removeEventListener("mousemove",(function(e){U(e)})),window.removeEventListener("touchend",(function(){Q()})),window.removeEventListener("mouseup",(function(){Q()})),window.addEventListener("touchmove",(function(e){U(e)})),window.addEventListener("mousemove",(function(e){U(e)})),window.addEventListener("touchend",(function(){Q()})),window.addEventListener("mouseup",(function(){Q()}))}function U(e){let t;if(e=e||window.event,R.value&&!1===V.value){t=e.touches?e.touches[0].pageX:e.clientX;let i=t-X.value.getBoundingClientRect().left;i>=X.value.offsetWidth-parseInt(parseInt(v.value.width)/2)-2&&(i=X.value.offsetWidth-parseInt(parseInt(v.value.width)/2)-2),i<=0&&(i=parseInt(parseInt(v.value.width)/2)),O.value=i-G.value+"px",E.value=i-G.value+"px"}}function Q(){if(k.value=new Date,R.value&&!1===V.value){let e=parseInt((O.value||"").replace("px",""));e=310*e/parseInt(L.imgWidth);let t={verifyData:y.value?I.crypto.AES.encrypt(e.toString(),y.value):e,id:x.value};F.verifyCaptcha.post(t).then((e=>{e.data?(D.value="#5cb85c",_.value="#5cb85c",j.value="white",M.value="icon-check",P.value=!1,V.value=!0,"pop"===n.value&&setTimeout((()=>{m.$parent.clickShow=!1,Y()}),1500),f.value=!0,$.value=m.$t("{secs} 秒 验证成功",{secs:((k.value-z.value)/1e3).toFixed(2)}),setTimeout((()=>{$.value="",m.$parent.closeBox(),m.$parent.$emit("success",t)}),1e3)):(D.value="#d9534f",_.value="#d9534f",j.value="white",M.value="icon-close",f.value=!1,setTimeout((function(){Y()}),1e3),m.$parent.$emit("error",m),$.value=m.$t("验证失败"),setTimeout((()=>{$.value=""}),1e3))})),R.value=!1}}l(u,(()=>{K()})),o((()=>{K(),m.$el.onselectstart=function(){return!1}}));const Y=()=>{P.value=!0,W.value="",N.value="left .3s",O.value=0,E.value=void 0,q.value="width .3s",_.value="gainsboro",D.value="white",j.value="black",M.value="icon-right",V.value=!1,J(),setTimeout((()=>{q.value="",N.value="",T.value=g.value}),300)};async function J(){let e,t={captchaType:c.value};try{e=await F.getCaptchaImage.post(t)}catch{$.value="发生错误"}A.value=e.data.backgroundImage,w.value=e.data.sliderImage,x.value=e.data.id,y.value=I.crypto.AES.encrypt(e.data.id,I.crypto.generateDerivedKey(m.tpl)),y.value.length>32&&(y.value=y.value.substring(0,32)),m.$parent.$emit("apiReady",e.data)}return{secretKey:y,passFlag:f,backImgBase:A,blockBackImgBase:w,backToken:x,startMoveTime:z,endMoveTime:k,tipsBackColor:B,tipWords:$,text:T,finishText:W,setSize:L,top:C,left:H,moveBlockLeft:O,leftBarWidth:E,moveBlockBackgroundColor:D,leftBarBorderColor:_,iconColor:j,iconClass:M,status:R,isEnd:V,showRefresh:P,transitionLeft:N,transitionWidth:q,barArea:X,refresh:Y,start:function(e){let t;t=(e=e||window.event).touches?e.touches[0].pageX:e.clientX,G.value=Math.floor(t-X.value.getBoundingClientRect().left),z.value=new Date,!1===V.value&&(T.value="",D.value="var(--el-color-primary)",_.value="var(--el-color-primary)",j.value="white",e.stopPropagation(),R.value=!0)}}}},[["render",function(e,t,i,a,l,o){const b=r("el-icon-refresh"),S=r("el-icon"),A=r("el-icon-arrow-right");return s(),n("div",$,["2"===i.type?(s(),n("div",{key:0,style:c({height:parseInt(a.setSize.imgHeight)+i.vSpace+"px"}),class:"verify-img-out"},[d("div",{style:c({width:a.setSize.imgWidth,height:a.setSize.imgHeight}),class:"verify-img-panel"},[d("img",{src:a.backImgBase,alt:"",style:{width:"100%",height:"100%",display:"block"}},null,8,T),p(d("div",{onClick:t[0]||(t[0]=(...e)=>a.refresh&&a.refresh(...e)),class:"verify-refresh"},[u(S,null,{default:v((()=>[u(b)])),_:1})],512),[[h,a.showRefresh]]),u(f,{name:"tips"},{default:v((()=>[a.tipWords?(s(),n("span",{key:0,class:g([a.passFlag?"suc-bg":"err-bg","verify-tips"])},m(a.tipWords),3)):y("",!0)])),_:1})],4)],4)):y("",!0),d("div",{style:c({width:a.setSize.imgWidth,height:i.barSize.height,"line-height":i.barSize.height}),class:"verify-bar-area"},[d("span",{textContent:m(a.text),class:"verify-msg"},null,8,W),d("div",{style:c({width:void 0!==a.leftBarWidth?a.leftBarWidth:i.barSize.height,height:i.barSize.height,"border-color":a.leftBarBorderColor,transaction:a.transitionWidth}),class:"verify-left-bar"},[d("span",{textContent:m(a.finishText),class:"verify-msg"},null,8,L),d("div",{style:c({width:i.barSize.height,height:i.barSize.height,"background-color":a.moveBlockBackgroundColor,left:a.moveBlockLeft,transition:a.transitionLeft}),onMousedown:t[1]||(t[1]=(...e)=>a.start&&a.start(...e)),onTouchstart:t[2]||(t[2]=(...e)=>a.start&&a.start(...e)),class:"verify-move-block"},[u(S,null,{default:v((()=>[u(A)])),_:1}),"2"===i.type?(s(),n("div",{key:0,style:c({width:Math.floor(47*parseInt(a.setSize.imgWidth)/310)+"px",height:a.setSize.imgHeight,top:"-"+(parseInt(a.setSize.imgHeight)+i.vSpace)+"px","background-size":a.setSize.imgWidth+" "+a.setSize.imgHeight}),class:"verify-sub-block"},[d("img",{src:a.blockBackImgBase,alt:"",style:{width:"100%",height:"100%",display:"block","-webkit-user-drag":"none"}},null,8,C)],4)):y("",!0)],36)],4)],4)])}]]),O={class:"mask"},E={class:"verifybox-top"},D={class:"verifybox-bottom",style:{padding:"1rem"}};const _=B({data:()=>({tpl:"yyyyMMdd"}),created(){this.tpl="yyyyMMdd"},components:{slide:H},props:{captchaType:{type:String,required:!0},figure:{type:Number},arith:{type:Number},mode:{type:String,default:"pop"},vSpace:{type:Number},explain:{type:String},imgSize:{type:Object,default:()=>({width:"310px",height:"155px"})},blockSize:{type:Object},barSize:{type:Object}},setup(i){const{captchaType:l,figure:o,arith:r,mode:s,vSpace:n,explain:c,imgSize:d,blockSize:p,barSize:h}=e(i),u=t(!1),v=t(void 0),g=t(void 0),m=t({}),y=a((()=>"pop"!==s.value||u.value));return A((()=>{switch(l.value){case"blockPuzzle":v.value="2",g.value="slide";break;case"clickWord":v.value="",g.value="point"}})),{clickShow:u,verifyType:v,componentType:g,instance:m,showBox:y,closeBox:()=>{u.value=!1,m.value.refresh&&m.value.refresh()},show:()=>{"pop"===s.value&&(u.value=!0)}}}},[["render",function(e,t,i,a,l,o){const g=r("el-icon-close"),f=r("el-icon");return p((s(),n("div",O,[d("div",{style:c({"max-width":parseInt(i.imgSize.width)+30+"px"}),class:"verifybox"},[d("div",E,[w(m(e.$t("请完成安全验证"))+" ",1),d("span",{onClick:t[0]||(t[0]=(...e)=>a.closeBox&&a.closeBox(...e)),class:"verifybox-close"},[u(f,null,{default:v((()=>[u(g)])),_:1})])]),d("div",D,[a.componentType?(s(),x(z(a.componentType),{key:0,arith:i.arith,barSize:i.barSize,blockSize:i.blockSize,captchaType:i.captchaType,explain:i.explain,figure:i.figure,imgSize:i.imgSize,mode:i.mode,tpl:l.tpl,type:a.verifyType,vSpace:i.vSpace,ref:"instance"},null,8,["arith","barSize","blockSize","captchaType","explain","figure","imgSize","mode","tpl","type","vSpace"])):y("",!0)])],4)],512)),[[h,a.showBox]])}]]),j={class:"msg-yzm"},M={key:0};const R=B({emits:[],props:{modelValue:{type:Object},vue:{type:Object},formName:{type:String},phonePlaceHolder:{type:String},phoneField:{type:Object},codeField:{type:Object},phoneLabel:{type:String},codeLabel:{type:String}},data:()=>({sendDisabled:!1,waitSecs:0,loading:!1,form:{}}),watch:{form:{deep:!0,handler(e){this.$emit("update:modelValue",e)}},modelValue:{immediate:!0,deep:!0,handler(e){this.form=e??{}}}},mounted(){},created(){},components:{naVerify:_},computed:{},methods:{async captchaSuccess(e){var t;this.sendDisabled=!0;try{const i=await this.$API.sys_verifycode.sendVerifyCode.post({destDevice:this.form[Array.isArray(this.phoneField)?this.phoneField[1]:this.phoneField],type:"login",deviceType:"mobile",verifyCaptchaReq:e});this.$message.success(this.$t("发送成功")),(null==(t=i.data)?void 0:t.code)&&this.$message.success(i.data.code.toString()),this.waitSecs=60;const a=setInterval((()=>{this.waitSecs-=1,this.waitSecs<1&&(clearInterval(a),this.sendDisabled=!1,this.waitSecs=0)}),1e3)}catch{this.loading=!1}},async getYzm(){if(!(await this.vue.$refs[this.formName].validateField(Array.isArray(this.phoneField)?this.phoneField[0]:this.phoneField).catch((()=>{}))))return!1;this.$refs.verify.show()}}},[["render",function(e,t,i,a,l,o){const c=r("el-input"),p=r("el-form-item"),h=r("el-button"),g=r("na-verify");return s(),n(k,null,[u(p,{label:i.phoneLabel,prop:Array.isArray(i.phoneField)?i.phoneField[0]:i.phoneField},{default:v((()=>[u(c,{modelValue:l.form[Array.isArray(i.phoneField)?i.phoneField[1]:i.phoneField],"onUpdate:modelValue":t[0]||(t[0]=e=>l.form[Array.isArray(i.phoneField)?i.phoneField[1]:i.phoneField]=e),placeholder:i.phonePlaceHolder,clearable:"",maxlength:"11",oninput:"value=value.replace(/\\D/g,'')","prefix-icon":"el-icon-iphone"},{prepend:v((()=>t[2]||(t[2]=[w("+86")]))),_:1},8,["modelValue","placeholder"])])),_:1},8,["label","prop"]),u(p,{label:i.codeLabel,prop:Array.isArray(i.codeField)?i.codeField[0]:i.codeField},{default:v((()=>[d("div",j,[u(c,{modelValue:l.form[Array.isArray(i.codeField)?i.codeField[1]:i.codeField],"onUpdate:modelValue":t[1]||(t[1]=e=>l.form[Array.isArray(i.codeField)?i.codeField[1]:i.codeField]=e),placeholder:e.$t("短信验证码"),clearable:"",maxlength:"4",oninput:"value=value.replace(/\\D/g,'')","prefix-icon":"el-icon-message"},null,8,["modelValue","placeholder"]),u(h,{disabled:l.sendDisabled,onClick:o.getYzm},{default:v((()=>[w(m(e.$t("获取验证码"))+" ",1),l.sendDisabled?(s(),n("span",M," ("+m(l.waitSecs)+")",1)):y("",!0)])),_:1},8,["disabled","onClick"])])])),_:1},8,["label","prop"]),u(g,{explain:e.$t("向右滑动完成验证"),imgSize:{width:"310px",height:"155px"},onSuccess:o.captchaSuccess,captchaType:"blockPuzzle",mode:"pop",ref:"verify"},null,8,["explain","onSuccess"])],64)}],["__scopeId","data-v-e2005303"]]),V={mobile:e=>({required:!0,message:"您的手机号码",pattern:e.$GLOBAL.chars.RGX_MOBILE}),mobileNoUsed:(e,t)=>({validator:async(i,a,l)=>{try{if((await e.$API.sys_user.checkMobileAvailable.post({mobile:a,id:t()})).data)return l()}catch{}l(new Error("手机号已被使用"))},trigger:"blur"}),code:()=>({required:!0,message:"请输入4位数字验证码"})};export{_ as a,R as n,V as p};
