const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./save-Wq7fgWab.js","./index-Bx7rElEd.js","./@vue-_BCsYqm-.js","./element-plus-CoQd9HEf.js","./lodash-es-DCh--ulG.js","./@vueuse-DKZ1O7gq.js","./@element-plus-DpD46RjY.js","./@sxzz-CpAfbxx4.js","./@ctrl-D2oWfImC.js","./dayjs-Cud5yAXI.js","./async-validator-BTKOuuO-.js","./memoize-one-Ds0C_khL.js","./normalize-wheel-es-Vn5vHDCm.js","./@floating-ui-DT7V1Oc1.js","../css/element-plus-B3lJtvYm.css","./crypto-js-BfYQ37JU.js","./axios-DMXdiZgf.js","./vue-router-DP39kmEB.js","./nprogress-BX4rmQ7W.js","../css/nprogress-BgDCIyLK.css","./vuex-CNGLPxA3.js","./json-bigint-D0bu8vFr.js","./bignumber.js-iDjSUVmj.js","./vue-i18n-DbMEmpqT.js","./@intlify-CZIS8eQd.js","./vue3-json-viewer-B-aZDOpp.js","../css/vue3-json-viewer-ByH33Jf7.css","./ace-builds-D9YH2WY7.js","./vue3-ace-editor-ubj-WOyx.js","./resize-observer-polyfill-CzGuHLZU.js","./sortablejs-BALiOaUQ.js","./vkbeautify-DEVEMlla.js","../css/index-CllpfDYF.css"])))=>i.map(i=>d[i]);
import{_ as e,e as t,n as s,d as a,a as l}from"./index-Bx7rElEd.js";import{ai as o,aj as i,at as r,o as n,c as d,S as u,K as c,L as p,J as h,a as m,P as y,Q as b,T as f,O as $,R as g,aE as v}from"./@vue-_BCsYqm-.js";import"./element-plus-CoQd9HEf.js";import"./lodash-es-DCh--ulG.js";import"./@vueuse-DKZ1O7gq.js";import"./@element-plus-DpD46RjY.js";import"./@sxzz-CpAfbxx4.js";import"./@ctrl-D2oWfImC.js";import"./dayjs-Cud5yAXI.js";import"./async-validator-BTKOuuO-.js";import"./memoize-one-Ds0C_khL.js";import"./normalize-wheel-es-Vn5vHDCm.js";import"./@floating-ui-DT7V1Oc1.js";import"./crypto-js-BfYQ37JU.js";import"./axios-DMXdiZgf.js";import"./vue-router-DP39kmEB.js";import"./nprogress-BX4rmQ7W.js";import"./vuex-CNGLPxA3.js";import"./json-bigint-D0bu8vFr.js";import"./bignumber.js-iDjSUVmj.js";import"./vue-i18n-DbMEmpqT.js";import"./@intlify-CZIS8eQd.js";import"./vue3-json-viewer-B-aZDOpp.js";import"./ace-builds-D9YH2WY7.js";import"./vue3-ace-editor-ubj-WOyx.js";import"./resize-observer-polyfill-CzGuHLZU.js";import"./sortablejs-BALiOaUQ.js";import"./vkbeautify-DEVEMlla.js";const w=v((()=>l((()=>import("./save-Wq7fgWab.js")),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32]),import.meta.url))),j={class:"left-panel"},C={class:"right-panel"},_=["title"];const x=e({components:{naIndicator:t,saveDialog:w},computed:{naColOperation:()=>s,table:()=>a},created(){},data(){return{statistics:{total:"..."},dialog:{},loading:!1,query:{dynamicFilter:{filters:[{field:"enabled",operator:"eq",value:!0}]},filter:{},keywords:this.keywords||this.$route.query.keywords},selection:[],timer:null}},inject:["reload"],methods:{async getStatistics(){var e;const t=await Promise.all([this.$API.sys_job.countBy.post({dynamicFilter:{filters:this.query.dynamicFilter.filters},requiredFields:["Status"]}),this.$API.sys_job.countBy.post({dynamicFilter:{filters:this.query.dynamicFilter.filters},requiredFields:["Enabled"]}),this.$API.sys_job.countBy.post({dynamicFilter:{filters:[...this.query.dynamicFilter.filters,{field:"LastStatusCode",operator:"notEqual"}]},requiredFields:["LastStatusCode"]})]);this.statistics.total=null==(e=this.$refs.table)?void 0:e.total,this.statistics.status=t[0].data,this.statistics.enabled=t[1].data,this.statistics.lastStatusCode=t[2].data},async copyJob(e){let t=this.$loading();try{(await this.$API.sys_job.create.post(Object.assign({},e,{id:0,jobName:e.jobName+"-copy",enabled:!1,nextTimeId:null,status:"idle"}))).data?this.$message.success(this.$t("操作成功")):this.$message.error(this.$t("操作失败")),this.$refs.table.refresh()}catch{}null==t||t.close()},async setEnabled(e){let t;try{await this.$confirm(this.$t("确定要 {operator} 选中的 {count} 项吗？",{operator:e?this.$t("启用"):this.$t("禁用"),count:this.selection.length}),this.$t("提示"),{type:"warning"}),t=this.$loading();const s=await Promise.all(this.selection.map((t=>this.$API.sys_job.setEnabled.post(Object.assign(t,{enabled:e})))));this.$message.success(this.$t("操作成功 {count}/{total} 项",{count:s.map((e=>e.data??0)).reduce(((e,t)=>e+t),0),total:this.selection.length}))}catch{}this.$refs.table.refresh(),null==t||t.close()},filterChange(e){Object.entries(e).forEach((([e,t])=>{this.$refs.search.form.dy[e]="true"===t||"false"!==t&&t})),this.$refs.search.search()},async changeSwitch(e,t){try{await this.$API.sys_job.setEnabled.post(t),this.$message.success(this.$t("操作成功"))}catch{}this.$refs.table.refresh()},async execute(e){try{await this.$API.sys_job.execute.post({id:e.id}),this.$notify.success({dangerouslyUseHTMLString:!0,message:o("div",{id:"countdown"},this.$t("已发起执行请求，5 秒后弹出执行结果")),onClose:async()=>{clearInterval(this.timer),this.dialog.save={row:e,mode:"view",tabId:"record"}}}),this.timer=setInterval((()=>{const e=new RegExp("\\d+").exec(document.getElementById("countdown").innerText)[0],t=parseInt(e)-1;document.getElementById("countdown").innerText=document.getElementById("countdown").innerText.replace(e,`${t<0?0:t}`)}),1e3)}catch{}this.$refs.table.refresh()},onReset(){Object.entries(this.$refs.selectFilter.selected).forEach((([e,t])=>this.$refs.selectFilter.selected[e]=[""])),this.$refs.selectFilter.selected.enabled=[!0]},async onSearch(e){Array.isArray(e.dy.createdTime)&&this.query.dynamicFilter.filters.push({field:"createdTime",operator:"dateRange",value:e.dy.createdTime.map((e=>e.replace(/ 00:00:00$/,"")))}),"string"==typeof e.dy.status&&""!==e.dy.status.trim()&&this.query.dynamicFilter.filters.push({field:"status",operator:"eq",value:e.dy.status}),"string"==typeof e.dy.lastStatusCode&&""!==e.dy.lastStatusCode.trim()&&this.query.dynamicFilter.filters.push({field:"lastStatusCode",operator:"eq",value:e.dy.lastStatusCode}),"boolean"==typeof e.dy.enabled&&this.query.dynamicFilter.filters.push({field:"enabled",operator:"eq",value:e.dy.enabled}),"string"==typeof e.dy.httpMethod&&""!==e.dy.httpMethod.trim()&&this.query.dynamicFilter.filters.push({field:"httpMethod",operator:"eq",value:e.dy.httpMethod}),await this.$refs.table.upData()}},async mounted(){(this.keywords||this.$route.query.keywords)&&(this.$refs.search.form.root.keywords=this.keywords||this.$route.query.keywords,this.$refs.search.keeps.push({field:"keywords",value:this.keywords||this.$route.query.keywords,type:"root"})),this.$refs.search.form.dy.enabled=!0,this.$refs.search.keeps.push({field:"enabled",value:!0,type:"dy"}),this.onReset()},props:["keywords"],watch:{}},[["render",function(e,t,s,a,l,o){const v=i("scStatistic"),w=i("el-card"),x=i("el-col"),k=i("el-row"),S=i("el-header"),q=i("scSelectFilter"),E=i("na-search"),F=i("el-button"),O=i("naButtonBulkDel"),I=i("el-icon-arrow-down"),T=i("el-icon"),D=i("el-dropdown-item"),A=i("el-dropdown-menu"),L=i("el-dropdown"),M=i("el-table-column"),P=i("naColId"),B=i("naColIndicator"),R=i("na-indicator"),Y=i("el-switch"),z=i("naColOperation"),H=i("scTable"),V=i("el-main"),G=i("el-container"),N=i("save-dialog"),U=r("loading"),J=r("time");return n(),d(g,null,[u(G,null,{default:c((()=>[p((n(),h(S,{class:"el-header-statistics"},{default:c((()=>[u(k,{gutter:15},{default:c((()=>[u(x,{lg:24},{default:c((()=>[u(w,{shadow:"never"},{default:c((()=>[u(v,{value:l.statistics.total,"group-separator":"",title:"总数"},null,8,["value"])])),_:1})])),_:1})])),_:1})])),_:1})),[[U,"..."===l.statistics.total]]),u(S,{class:"el-header-select-filter"},{default:c((()=>{var t,s,a,i,r;return[u(q,{data:[{title:e.$t("作业状态"),key:"status",options:[{label:e.$t("全部"),value:""},...Object.entries(this.$GLOBAL.enums.jobStatues).map((e=>{var t,s;return{value:e[0],label:e[1][1],badge:null==(s=null==(t=this.statistics.status)?void 0:t.find((t=>t.key.status.toLowerCase()===e[0].toLowerCase())))?void 0:s.value}}))]},{title:e.$t("启用状态"),key:"enabled",options:[{label:e.$t("全部"),value:""},{label:e.$t("启用"),value:!0,badge:null==(s=null==(t=l.statistics.enabled)?void 0:t.find((e=>"True"===e.key.enabled)))?void 0:s.value},{label:e.$t("禁用"),value:!1,badge:null==(i=null==(a=l.statistics.enabled)?void 0:a.find((e=>"False"===e.key.enabled)))?void 0:i.value}]},{title:e.$t("上次执行状态"),key:"lastStatusCode",options:[{label:e.$t("全部"),value:""},...(null==(r=this.statistics.lastStatusCode)?void 0:r.map((e=>({value:e.key.lastStatusCode,label:e.key.lastStatusCode,badge:e.value}))))??[]]}],"label-width":10,onOnChange:o.filterChange,ref:"selectFilter"},null,8,["data","onOnChange"])]})),_:1}),u(S,null,{default:c((()=>[m("div",j,[u(E,{controls:[{type:"select",field:["dy","httpMethod"],options:Object.entries(this.$GLOBAL.enums.httpMethods).map((e=>({value:e[0],label:e[1][1]}))),placeholder:e.$t("请求方式"),style:"width:15rem"},{type:"input",field:["root","keywords"],placeholder:e.$t("作业编号 / 作业名称"),style:"width:20rem"}],vue:this,onReset:o.onReset,onSearch:o.onSearch,dateFormat:"YYYY-MM-DD HH:mm:ss",dateType:"datetimerange",dateValueFormat:"YYYY-MM-DD HH:mm:ss",ref:"search"},null,8,["controls","onReset","onSearch"])]),m("div",C,[u(F,{onClick:t[0]||(t[0]=e=>this.dialog.save={mode:"add"}),icon:"el-icon-plus",type:"primary"}),u(O,{api:e.$API.sys_job.bulkDelete,vue:this},null,8,["api"]),p(u(L,null,{dropdown:c((()=>[u(A,null,{default:c((()=>[u(D,{onClick:t[1]||(t[1]=e=>o.setEnabled(!0))},{default:c((()=>[y(b(e.$t("启用作业")),1)])),_:1}),u(D,{onClick:t[2]||(t[2]=e=>o.setEnabled(!1))},{default:c((()=>[y(b(e.$t("禁用作业")),1)])),_:1})])),_:1})])),default:c((()=>[u(F,{type:"primary"},{default:c((()=>[y(b(e.$t("批量操作"))+" ",1),u(T,null,{default:c((()=>[u(I)])),_:1})])),_:1})])),_:1},512),[[f,this.selection.length>0]])])])),_:1}),u(V,{class:"nopadding"},{default:c((()=>[u(H,{"cell-style":e=>{if("lastDuration"===e.column.property&&e.row.lastDuration>1e3)return{color:"var(--el-color-danger)"}},"context-menus":["id","jobName","executionCron","status","httpMethod","lastExecTime","lastStatusCode","nextExecTime","enabled","createdTime","lastDuration"],"default-sort":{prop:"lastExecTime",order:"descending"},"export-api":e.$API.sys_job.export,"page-size":100,params:l.query,"query-api":e.$API.sys_job.pagedQuery,vue:this,onDataChange:o.getStatistics,onSelectionChange:t[3]||(t[3]=e=>{l.selection=e}),ref:"table","remote-filter":"","remote-sort":"","row-key":"id",stripe:""},{default:c((()=>[u(M,{type:"selection",width:"50"}),u(P,{label:e.$t("作业编号"),prop:"id",sortable:"custom",width:"170"},null,8,["label"]),u(M,{label:e.$t("作业名称"),"min-width":"150",prop:"jobName","show-overflow-tooltip":"",sortable:"custom"},null,8,["label"]),u(M,{label:e.$t("执行计划"),align:"right",prop:"executionCron",sortable:"custom",width:"150"},{default:c((({row:e})=>[m("p",null,b(e.cronDescription),1),m("p",null,b(e.executionCron),1)])),_:1},8,["label"]),u(B,{label:e.$t("作业状态"),options:Object.entries(this.$GLOBAL.enums.jobStatues).map((e=>({value:e[0],text:e[1][1],type:e[1][2],pulse:"true"===e[1][3]}))),align:"center",prop:"status",sortable:"custom",width:"100"},null,8,["label","options"]),u(B,{label:e.$t("请求方式"),options:Object.entries(this.$GLOBAL.enums.httpMethods).map((e=>({value:e[0],text:e[1][1],type:e[1][2],pulse:"true"===e[1][3]}))),align:"center",prop:"httpMethod",sortable:"custom",width:"150"},null,8,["label","options"]),u(M,{label:e.$t("上次执行"),align:"center"},{default:c((()=>[u(M,{label:e.$t("状态"),align:"center",prop:"lastStatusCode",sortable:"custom",width:"100"},{default:c((({row:e})=>[u(R,{data:e,options:Object.entries(this.$GLOBAL.enums.httpStatusCodes).map((e=>({value:e[0],text:`${e[1][1]}`,type:e[1][2],pulse:"true"===e[1][3]}))),prop:"lastStatusCode"},null,8,["data","options"])])),_:1},8,["label"]),u(M,{label:e.$t("时间"),align:"right",prop:"lastExecTime",sortable:"custom",width:"100"},{default:c((({row:e})=>[e.lastExecTime?p((n(),d("span",{key:0,title:e.lastExecTime},null,8,_)),[[J,e.lastExecTime,void 0,{tip:!0}]]):$("",!0)])),_:1},8,["label"]),u(M,{formatter:t=>t.lastDuration?`${e.$TOOL.groupSeparator(t.lastDuration.toFixed(0))} ms`:"-",label:e.$t("耗时"),align:"right",prop:"lastDuration",sortable:"custom",width:"100"},null,8,["formatter","label"])])),_:1},8,["label"]),u(M,{label:e.$t("下次执行时间"),align:"right",prop:"nextExecTime",sortable:"custom",width:"170"},null,8,["label"]),u(M,{label:e.$t("启用"),align:"center",prop:"enabled",sortable:"custom",width:"100"},{default:c((({row:e})=>[u(Y,{modelValue:e.enabled,"onUpdate:modelValue":t=>e.enabled=t,onChange:t=>o.changeSwitch(t,e)},null,8,["modelValue","onUpdate:modelValue","onChange"])])),_:1},8,["label"]),u(z,{buttons:o.naColOperation.buttons.concat({icon:"el-icon-video-play",title:"立即执行",click:o.execute},{icon:"el-icon-document-copy",confirm:!0,title:"复制作业",click:o.copyJob},o.naColOperation.delButton("删除作业",e.$API.sys_job.delete)),vue:this,width:"220"},null,8,["buttons"])])),_:1},8,["cell-style","export-api","params","query-api","onDataChange"])])),_:1})])),_:1}),l.dialog.save?(n(),h(N,{key:0,onClosed:t[4]||(t[4]=e=>l.dialog.save=null),onMounted:t[5]||(t[5]=t=>e.$refs.saveDialog.open(l.dialog.save)),onSuccess:t[6]||(t[6]=(t,s)=>o.table.handleUpdate(e.$refs.table,t,s)),ref:"saveDialog"},null,512)):$("",!0)],64)}]]);export{x as default};
